version: "3.8"

networks:
  backbone:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.0.0/24

  lan1:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.1.0/24

  lan2:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.2.0/24

services:
  router-central:
    image: frrouting/frr:latest
    container_name: router-central
    privileged: true
    networks:
      backbone:
        ipv4_address: 10.0.0.254
    ports:
      - "161:161/udp"
    volumes:
      - ./frr/router-central/frr.conf:/etc/frr/frr.conf
      - ./snmp/snmpd-router.conf:/etc/snmp/snmpd.conf
    command: >
      sh -c "
      apk add --no-cache net-snmp net-snmp-tools &&
      snmpd -f -Lo -c /etc/snmp/snmpd.conf &
      sysctl -w net.ipv4.ip_forward=1 &&
      /usr/lib/frr/frrinit.sh start &&
      tail -f /dev/null
      "

  ce1-router:
    image: frrouting/frr:latest
    container_name: ce1-router
    privileged: true
    networks:
      backbone:
        ipv4_address: 10.0.0.101
      lan1:
        ipv4_address: 10.10.1.254
    ports:
      - "1161:161/udp"
    volumes:
      - ./frr/ce1/frr.conf:/etc/frr/frr.conf
      - ./snmp/snmpd-ce1.conf:/etc/snmp/snmpd.conf
    command: >
      sh -c "
      apk add --no-cache net-snmp net-snmp-tools &&
      snmpd -f -Lo -c /etc/snmp/snmpd.conf &
      sysctl -w net.ipv4.ip_forward=1 &&
      /usr/lib/frr/frrinit.sh start &&
      tail -f /dev/null
      "

  ce2-router:
    image: frrouting/frr:latest
    container_name: ce2-router
    privileged: true
    networks:
      backbone:
        ipv4_address: 10.0.0.102
      lan2:
        ipv4_address: 10.10.2.254
    ports:
      - "2161:161/udp"
    volumes:
      - ./frr/ce2/frr.conf:/etc/frr/frr.conf
      - ./snmp/snmpd-ce2.conf:/etc/snmp/snmpd.conf
    command: >
      sh -c "
      apk add --no-cache net-snmp net-snmp-tools &&
      snmpd -f -Lo -c /etc/snmp/snmpd.conf &
      sysctl -w net.ipv4.ip_forward=1 &&
      /usr/lib/frr/frrinit.sh start &&
      tail -f /dev/null
      "

  lan1-switch:
    image: ubuntu:24.04
    container_name: lan1-switch
    privileged: true
    networks:
      lan1:
        ipv4_address: 10.10.1.2
    tty: true
    command: /bin/bash

  lan2-switch:
    image: ubuntu:24.04
    container_name: lan2-switch
    privileged: true
    networks:
      lan2:
        ipv4_address: 10.10.2.2
    tty: true
    command: /bin/bash

  snmp-exporter:
    image: prom/snmp-exporter:latest
    container_name: snmp-exporter
    networks:
      backbone:
        ipv4_address: 10.0.0.10
    volumes:
      - ./snmp/snmp.yml:/etc/snmp_exporter/snmp.yml:ro
    ports:
      - "9116:9116"

  blackbox-exporter:
    image: prom/blackbox-exporter:latest
    container_name: blackbox-exporter
    networks:
      backbone:
        ipv4_address: 10.0.0.11
    ports:
      - "9115:9115"

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    networks:
      backbone:
        ipv4_address: 10.0.0.12
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    networks:
      backbone:
        ipv4_address: 10.0.0.13
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    ports:
      - "3000:3000"

